<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBQ Orders App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Load React and ReactDOM from unpkg.com (UMD versions for global access) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Load Firebase SDKs from CDN (compat versions for global access) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Load Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        // Global variables for Firebase config (replace with your actual config)
        // You MUST replace YOUR_API_KEY, YOUR_AUTH_DOMAIN, etc. with values from your Firebase project.
        window.__app_id = "YOUR_FIREBASE_PROJECT_ID"; // projectId from firebaseConfig
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyAyxUhAi7wlxjNV_UqPf4zGCKe3VGCeT-M",
            authDomain: "bbqorders-763b2.firebaseapp.com",
            projectId: "bbqorders-763b2",
            storageBucket: "bbqorders-763b2.firebasestorage.app",
  	        messagingSenderId: "525014584357",
            appId: "1:525014584357:web:475cc586634367b86b03cc"
        });
        window.__initial_auth_token = null; // Or a custom token if you implement one
    </script>

    <!-- Your App component code, now embedded directly and transpiled by Babel -->
    <script type="text/babel">
        // Remove all import statements for React and Firebase as they are now loaded globally
        // import React, { useState, useEffect, useRef } from 'react';
        // import { initializeApp } from 'firebase/app';
        // import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
        // import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc } from 'firebase/firestore';

        // Ensure these global variables are available from the script above
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase outside the component to avoid re-initialization
        // These will be accessed globally from the Firebase compat SDKs loaded in index.html
        let app, db, auth;

        function App() {
          // Use React.useState, React.useEffect, React.useRef since React is global
          const [activeSection, setActiveSection] = React.useState('newOrder'); // 'newOrder', 'activeOrders', 'completedOrders', 'setup'
          const [menuItems, setMenuItems] = React.useState([]);
          const [currentOrder, setCurrentOrder] = React.useState([]);
          const [orders, setOrders] = React.useState([]); // All orders from Firestore
          const [orderCounter, setOrderCounter] = React.useState(1);
          const [newMenuItemName, setNewMenuItemName] = React.useState('');
          const [newMenuItemPrice, setNewMenuItemPrice] = React.useState('');
          const [isAuthReady, setIsAuthReady] = React.useState(false);
          const [userId, setUserId] = React.useState(null);
          const [showModal, setShowModal] = React.useState(false);
          const [modalContent, setModalContent] = React.useState({ title: '', message: '', onConfirm: null, showConfirm: false });

          // Refs for audio and notification
          const audioRef = React.useRef(null);
          const notificationRef = React.useRef(null);

          // Initialize Firebase and Auth
          React.useEffect(() => {
            try {
              // Use global firebase functions
              app = firebase.initializeApp(firebaseConfig);
              db = firebase.firestore().getFirestore(app);
              auth = firebase.auth().getAuth(app);

              const unsubscribe = firebase.auth().onAuthStateChanged(auth, async (user) => {
                if (user) {
                  setUserId(user.uid);
                  setIsAuthReady(true);
                  console.log('Firebase Auth Ready. User ID:', user.uid);
                } else {
                  try {
                    if (initialAuthToken) {
                      await firebase.auth().signInWithCustomToken(auth, initialAuthToken);
                      console.log('Signed in with custom token.');
                    } else {
                      await firebase.auth().signInAnonymously(auth);
                      console.log('Signed in anonymously.');
                    }
                  } catch (error) {
                    console.error('Error signing in:', error);
                    // Fallback to a random ID if auth fails completely
                    setUserId(crypto.randomUUID());
                    setIsAuthReady(true);
                  }
                }
              });

              return () => unsubscribe();
            } catch (error) {
              console.error('Firebase initialization error:', error);
              // Fallback to a random ID if firebase init fails completely
              setUserId(crypto.randomUUID());
              setIsAuthReady(true);
            }
          }, []);

          // Fetch Menu Items and Order Counter
          React.useEffect(() => {
            if (!isAuthReady || !db) return;

            // Use global firestore functions
            const menuItemsCollectionRef = firebase.firestore().collection(db, `artifacts/${appId}/public/data/menuItems`);
            const unsubscribeMenuItems = firebase.firestore().onSnapshot(menuItemsCollectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMenuItems(items.sort((a, b) => a.name.localeCompare(b.name))); // Sort alphabetically
            }, (error) => {
              console.error("Error fetching menu items:", error);
            });

            // Fetch Order Counter
            const appSettingsDocRef = firebase.firestore().doc(db, `artifacts/${appId}/public/data/appSettings`, 'orderCounter');
            const unsubscribeOrderCounter = firebase.firestore().onSnapshot(appSettingsDocRef, (docSnap) => {
              if (docSnap.exists()) {
                setOrderCounter(docSnap.data().count || 1);
              } else {
                // Initialize if not exists
                firebase.firestore().setDoc(appSettingsDocRef, { count: 1 }, { merge: true });
              }
            }, (error) => {
              console.error("Error fetching order counter:", error);
            });

            return () => {
              unsubscribeMenuItems();
              unsubscribeOrderCounter();
            };
          }, [isAuthReady, db]);

          // Fetch Orders
          React.useEffect(() => {
            if (!isAuthReady || !db) return;

            const ordersCollectionRef = firebase.firestore().collection(db, `artifacts/${appId}/public/data/orders`);
            // Order by timestamp to get the latest orders first in active/completed sections
            const q = firebase.firestore().query(ordersCollectionRef, firebase.firestore().orderBy('timestamp', 'desc'));

            const unsubscribeOrders = firebase.firestore().onSnapshot(q, (snapshot) => {
              const fetchedOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setOrders(fetchedOrders);
            }, (error) => {
              console.error("Error fetching orders:", error);
            });

            return () => unsubscribeOrders();
          }, [isAuthReady, db]);

          const showConfirmationModal = (title, message, onConfirm) => {
            setModalContent({ title, message, onConfirm, showConfirm: true });
            setShowModal(true);
          };

          const showInfoModal = (title, message) => {
            setModalContent({ title, message, onConfirm: null, showConfirm: false });
            setShowModal(true);
          };

          const closeModal = () => {
            setShowModal(false);
            setModalContent({ title: '', message: '', onConfirm: null, showConfirm: false });
          };

          // --- Menu Item Management ---
          const handleAddMenuItem = async () => {
            if (!newMenuItemName || !newMenuItemPrice || isNaN(parseFloat(newMenuItemPrice))) {
              showInfoModal('Input Error', 'Please enter a valid name and price for the menu item.');
              return;
            }
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }

            try {
              const price = parseFloat(newMenuItemPrice);
              await firebase.firestore().addDoc(firebase.firestore().collection(db, `artifacts/${appId}/public/data/menuItems`), {
                name: newMenuItemName,
                price: price,
              });
              setNewMenuItemName('');
              setNewMenuItemPrice('');
              showInfoModal('Success', `${newMenuItemName} added to menu.`);
            } catch (e) {
              console.error("Error adding document: ", e);
              showInfoModal('Error', 'Failed to add menu item. Please try again.');
            }
          };

          const handleDeleteMenuItem = async (id, name) => {
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }
            showConfirmationModal('Confirm Delete', `Are you sure you want to delete "${name}" from the menu?`, async () => {
              try {
                await firebase.firestore().deleteDoc(firebase.firestore().doc(db, `artifacts/${appId}/public/data/menuItems`, id));
                showInfoModal('Success', `${name} deleted from menu.`);
                closeModal();
              } catch (e) {
                console.error("Error deleting document: ", e);
                showInfoModal('Error', 'Failed to delete menu item. Please try again.');
              }
            });
          };

          // --- New Order Management ---
          const addItemToCurrentOrder = (item) => {
            setCurrentOrder(prevOrder => {
              const existingItemIndex = prevOrder.findIndex(i => i.id === item.id);
              if (existingItemIndex > -1) {
                const updatedOrder = [...prevOrder];
                updatedOrder[existingItemIndex].quantity += 1;
                return updatedOrder;
              } else {
                return [...prevOrder, { ...item, quantity: 1, isReady: false, isServed: false }];
              }
            });
          };

          const removeItemFromCurrentOrder = (itemToRemove) => {
            setCurrentOrder(prevOrder => {
              const existingItemIndex = prevOrder.findIndex(item => item.id === itemToRemove.id);
              if (existingItemIndex > -1) {
                const updatedOrder = [...prevOrder];
                if (updatedOrder[existingItemIndex].quantity > 1) {
                  updatedOrder[existingItemIndex].quantity -= 1;
                } else {
                  updatedOrder.splice(existingItemIndex, 1);
                }
                return updatedOrder;
              }
              return prevOrder;
            });
          };

          const calculateCurrentOrderTotal = () => {
            return currentOrder.reduce((total, item) => total + (item.price * item.quantity), 0).toFixed(2);
          };

          const handlePaidOrder = async () => {
            if (currentOrder.length === 0) {
              showInfoModal('Empty Order', 'Please add items to the order before marking as paid.');
              return;
            }
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }

            try {
              const now = new Date();
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              const timestamp = `${hours}:${minutes}`;

              const newOrderDoc = {
                orderNumber: orderCounter,
                timestamp: now.getTime(), // Use milliseconds for sorting in Firestore
                displayTime: timestamp, // For display purposes
                status: 'active',
                items: currentOrder,
                total: parseFloat(calculateCurrentOrderTotal()),
                userId: userId, // Store the user who created the order
              };

              await firebase.firestore().addDoc(firebase.firestore().collection(db, `artifacts/${appId}/public/data/orders`), newOrderDoc);

              // Increment order counter in Firestore
              const appSettingsDocRef = firebase.firestore().doc(db, `artifacts/${appId}/public/data/appSettings`, 'orderCounter');
              await firebase.firestore().updateDoc(appSettingsDocRef, { count: orderCounter + 1 });

              setCurrentOrder([]); // Clear current order
              setActiveSection('activeOrders'); // Navigate to active orders

              // Play ping sound and show notification
              if (audioRef.current) {
                audioRef.current.play();
              }
              if (notificationRef.current) {
                notificationRef.current.classList.add('animate-ping-once');
                setTimeout(() => {
                  notificationRef.current.classList.remove('animate-ping-once');
                }, 1000); // Duration of the animation
              }
              showInfoModal('Order Placed!', `Order #${orderCounter} has been added to active orders.`);

            } catch (e) {
              console.error("Error adding order: ", e);
              showInfoModal('Error', 'Failed to place order. Please try again.');
            }
          };

          const handleResetOrderCount = async () => {
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }
            showConfirmationModal('Confirm Reset', 'Are you sure you want to reset the order count to 1? This cannot be undone.', async () => {
              try {
                const appSettingsDocRef = firebase.firestore().doc(db, `artifacts/${appId}/public/data/appSettings`, 'orderCounter');
                await firebase.firestore().setDoc(appSettingsDocRef, { count: 1 });
                showInfoModal('Success', 'Order count has been reset to 1.');
                closeModal();
              } catch (e) {
                console.error("Error resetting order count: ", e);
                showInfoModal('Error', 'Failed to reset order count. Please try again.');
              }
            });
          };

          // --- Active Order Management ---
          const toggleItemStatus = async (orderId, itemIndex, statusType) => {
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }
            try {
              const orderRef = firebase.firestore().doc(db, `artifacts/${appId}/public/data/orders`, orderId);
              const orderSnap = await firebase.firestore().getDoc(orderRef);

              if (orderSnap.exists()) {
                const orderData = orderSnap.data();
                const updatedItems = [...orderData.items];
                updatedItems[itemIndex][statusType] = !updatedItems[itemIndex][statusType];

                // If an item is marked as served, it should also be marked as ready
                if (statusType === 'isServed' && updatedItems[itemIndex][statusType]) {
                  updatedItems[itemIndex]['isReady'] = true;
                }
                // If an item is marked as not ready, it should also be marked as not served
                if (statusType === 'isReady' && !updatedItems[itemIndex][statusType]) {
                  updatedItems[itemIndex]['isServed'] = false;
                }

                await firebase.firestore().updateDoc(orderRef, { items: updatedItems });

                // Check if all items are served in this order
                const allServed = updatedItems.every(item => item.isServed);
                if (allServed) {
                  await firebase.firestore().updateDoc(orderRef, { status: 'completed' });
                  showInfoModal('Order Completed!', `Order #${orderData.orderNumber} has been moved to completed orders.`);
                }
              }
            } catch (e) {
              console.error("Error updating item status: ", e);
              showInfoModal('Error', 'Failed to update item status. Please try again.');
            }
          };

          const toggleAllItemsStatus = async (orderId, statusType) => {
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }
            try {
              const orderRef = firebase.firestore().doc(db, `artifacts/${appId}/public/data/orders`, orderId);
              const orderSnap = await firebase.firestore().getDoc(orderRef);

              if (orderSnap.exists()) {
                const orderData = orderSnap.data();
                const updatedItems = orderData.items.map(item => ({
                  ...item,
                  [statusType]: true,
                  // If marking all served, also mark all ready
                  ...(statusType === 'isServed' && { isReady: true })
                }));
                await firebase.firestore().updateDoc(orderRef, { items: updatedItems });

                // If all items are served, mark order as completed
                if (statusType === 'isServed') {
                  await firebase.firestore().updateDoc(orderRef, { status: 'completed' });
                  showInfoModal('Order Completed!', `Order #${orderData.orderNumber} has been moved to completed orders.`);
                }
              }
            } catch (e) {
              console.error("Error updating all items status: ", e);
              showInfoModal('Error', 'Failed to update all items status. Please try again.');
            }
          };

          const getActiveOrderTotals = () => {
            const activeOrders = orders.filter(order => order.status === 'active');
            const itemCounts = {};

            activeOrders.forEach(order => {
              order.items.forEach(item => {
                itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
              });
            });

            return Object.entries(itemCounts).sort((a, b) => a[0].localeCompare(b[0]));
          };

          // --- Completed Order Management ---
          const handleReopenOrder = async (orderId, orderNumber) => {
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }
            showConfirmationModal('Confirm Reopen', `Are you sure you want to reopen Order #${orderNumber}? It will move back to active orders.`, async () => {
              try {
                const orderRef = firebase.firestore().doc(db, `artifacts/${appId}/public/data/orders`, orderId);
                await firebase.firestore().updateDoc(orderRef, { status: 'active' });
                showInfoModal('Success', `Order #${orderNumber} reopened.`);
                closeModal();
              } catch (e) {
                console.error("Error reopening order: ", e);
                showInfoModal('Error', 'Failed to reopen order. Please try again.');
              }
            });
          };

          const handleEditOrder = (order) => {
            // This is a simplified edit. For a full edit, you'd load the order into currentOrder
            // and allow modification, then save it back. For now, we'll just show an info modal.
            showInfoModal('Edit Order', `Editing Order #${order.orderNumber} is not fully implemented in this demo. You can manually edit it in Firebase Firestore.`);
            // A more robust implementation would involve:
            // 1. Setting currentOrder to a deep copy of order.items
            // 2. Setting a state like `isEditingOrder` to true
            // 3. Changing the 'Paid' button to 'Update Order'
            // 4. On 'Update Order', use `setDoc(orderRef, newOrderData)` instead of `addDoc`.
          };

          const handleDeleteOrder = async (orderId, orderNumber) => {
            if (!db) {
              showInfoModal('Error', 'Database not initialized. Please try again.');
              return;
            }
            showConfirmationModal('Confirm Delete', `Are you sure you want to permanently delete Order #${orderNumber}? This cannot be undone.`, async () => {
              try {
                await firebase.firestore().deleteDoc(firebase.firestore().doc(db, `artifacts/${appId}/public/data/orders`, orderId));
                showInfoModal('Success', `Order #${orderNumber} deleted.`);
                closeModal();
              } catch (e) {
                console.error("Error deleting order: ", e);
                showInfoModal('Error', 'Failed to delete menu item. Please try again.');
              }
            });
          };

          // --- Export Orders to CSV ---
          const handleExportOrders = () => {
            if (orders.length === 0) {
              showInfoModal('No Orders', 'There are no orders to export.');
              return;
            }

            let csvContent = "Order Number,Timestamp,Status,Total,Item Name,Quantity,Ready,Served\n";

            orders.forEach(order => {
              order.items.forEach(item => {
                csvContent += `${order.orderNumber},${order.displayTime},${order.status},${order.total},"${item.name}",${item.quantity},${item.isReady ? 'Yes' : 'No'},${item.isServed ? 'Yes' : 'No'}\n`;
              });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection for download attribute
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', `bbq_orders_export_${new Date().toISOString().slice(0, 10)}.csv`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              showInfoModal('Export Complete', 'All orders have been exported to a CSV file.');
            } else {
              // Fallback for browsers that don't support download attribute
              showInfoModal('Export Failed', 'Your browser does not support direct CSV download. Please copy the content manually.');
              console.log(csvContent); // Log to console for manual copy
            }
          };

          // Filter orders for display
          const activeOrders = orders.filter(order => order.status === 'active');
          const completedOrders = orders.filter(order => order.status === 'completed');

          const totalCurrentOrderCost = calculateCurrentOrderTotal();

          return (
            <div className="min-h-screen bg-gray-100 flex flex-col font-inter text-gray-800">
              {/* Audio for ping notification */}
              <audio ref={audioRef} src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>

              {/* Global Notification Ping */}
              <div
                ref={notificationRef}
                className="fixed top-0 left-0 w-full h-2 bg-red-500 z-50 opacity-0 transition-opacity duration-500"
              ></div>

              {/* Modal Component */}
              {showModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto border-t-4 border-red-500">
                    <h3 className="text-xl font-bold text-gray-900 mb-4">{modalContent.title}</h3>
                    <p className="text-gray-700 mb-6">{modalContent.message}</p>
                    <div className="flex justify-end space-x-3">
                      {modalContent.showConfirm && (
                        <button
                          onClick={() => { modalContent.onConfirm && modalContent.onConfirm(); }}
                          className="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 shadow-md"
                        >
                          Confirm
                        </button>
                      )}
                      <button
                        onClick={closeModal}
                        className="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 shadow-md"
                      >
                        {modalContent.showConfirm ? 'Cancel' : 'Close'}
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Header Navigation */}
              <nav className="bg-red-600 text-white p-4 shadow-md sticky top-0 z-10">
                <div className="flex justify-between items-center max-w-md mx-auto">
                  <button
                    onClick={() => setActiveSection('newOrder')}
                    className={`flex-1 py-2 rounded-lg transition duration-200 ${activeSection === 'newOrder' ? 'bg-red-700 font-bold' : 'hover:bg-red-500'}`}
                  >
                    New Order
                  </button>
                  <button
                    onClick={() => setActiveSection('activeOrders')}
                    className={`flex-1 py-2 rounded-lg transition duration-200 ml-2 ${activeSection === 'activeOrders' ? 'bg-red-700 font-bold' : 'hover:bg-red-500'}`}
                  >
                    Active
                  </button>
                  <button
                    onClick={() => setActiveSection('completedOrders')}
                    className={`flex-1 py-2 rounded-lg transition duration-200 ml-2 ${activeSection === 'completedOrders' ? 'bg-red-700 font-bold' : 'hover:bg-red-500'}`}
                  >
                    Completed
                  </button>
                  <button
                    onClick={() => setActiveSection('setup')}
                    className={`flex-1 py-2 rounded-lg transition duration-200 ml-2 ${activeSection === 'setup' ? 'bg-red-700 font-bold' : 'hover:bg-red-500'}`}
                  >
                    Setup
                  </button>
                </div>
              </nav>

              {/* Main Content Area */}
              <main className="flex-1 overflow-y-auto p-4 pb-20 max-w-md mx-auto w-full">
                {/* New Order Section */}
                {activeSection === 'newOrder' && (
                  <section className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">New BBQ Order</h2>
                    <p className="text-lg text-gray-700 mb-4 text-center">Order #<span className="font-bold text-red-600">{orderCounter}</span></p>

                    <div className="grid grid-cols-2 gap-3 mb-6">
                      {menuItems.length > 0 ? menuItems.map(item => (
                        <button
                          key={item.id}
                          onClick={() => addItemToCurrentOrder(item)}
                          className="bg-red-100 text-red-800 p-4 rounded-lg shadow-md hover:bg-red-200 transition duration-200 active:scale-95 transform flex flex-col items-center justify-center"
                        >
                          <span className="font-semibold text-lg">{item.name}</span>
                          <span className="text-sm">£{item.price.toFixed(2)}</span>
                        </button>
                      )) : (
                        <p className="col-span-2 text-center text-gray-500">No menu items yet. Go to Setup to add some!</p>
                      )}
                    </div>

                    <h3 className="text-xl font-bold text-gray-900 mb-3">Current Order:</h3>
                    {currentOrder.length === 0 ? (
                      <p className="text-gray-500 text-center mb-6">No items in current order.</p>
                    ) : (
                      <ul className="mb-6 space-y-2">
                        {currentOrder.map(item => (
                          <li key={item.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                            <span className="text-gray-800 font-medium">{item.name} x {item.quantity}</span>
                            <div className="flex items-center space-x-2">
                              <span className="text-gray-600">£{(item.price * item.quantity).toFixed(2)}</span>
                              <button
                                onClick={() => removeItemFromCurrentOrder(item)}
                                className="bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm hover:bg-red-200 transition duration-200 active:scale-95 transform"
                              >
                                Remove
                              </button>
                            </div>
                          </li>
                        ))}
                      </ul>
                    )}

                    <div className="flex justify-between items-center text-2xl font-bold text-gray-900 mb-6 p-3 bg-red-50 rounded-lg">
                      <span>Total:</span>
                      <span>£{totalCurrentOrderCost}</span>
                    </div>

                    <button
                      onClick={handlePaidOrder}
                      className="w-full bg-red-600 text-white py-4 rounded-xl text-xl font-bold shadow-lg hover:bg-red-700 transition duration-200 active:scale-98 transform"
                    >
                      Paid
                    </button>
                  </section>
                )}

                {/* Active Orders Section */}
                {activeSection === 'activeOrders' && (
                  <section className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">Active Orders</h2>

                    {/* Totals Row */}
                    <div className="bg-red-50 p-4 rounded-lg mb-6 shadow-sm">
                      <h3 className="text-lg font-bold text-gray-800 mb-2">Total Items Across Active Orders:</h3>
                      {getActiveOrderTotals().length > 0 ? (
                        <ul className="grid grid-cols-2 gap-2 text-sm text-gray-700">
                          {getActiveOrderTotals().map(([name, count]) => (
                            <li key={name} className="flex justify-between">
                              <span>{name}:</span>
                              <span className="font-semibold">{count}</span>
                            </li>
                          ))}
                        </ul>
                      ) : (
                        <p className="text-gray-500 text-center">No active orders to total.</p>
                      )}
                    </div>

                    {activeOrders.length === 0 ? (
                      <p className="text-gray-500 text-center">No active orders.</p>
                    ) : (
                      <div className="space-y-6">
                        {activeOrders.map(order => (
                          <div key={order.id} className="bg-red-100 p-5 rounded-xl shadow-md border border-red-200">
                            <div className="flex justify-between items-center mb-3">
                              <h3 className="text-xl font-bold text-red-800">Order #{order.orderNumber}</h3>
                              <span className="text-lg font-semibold text-red-700">£{order.total.toFixed(2)}</span>
                            </div>
                            <p className="text-sm text-red-600 mb-4">Paid at: {order.displayTime}</p>
                            <ul className="mb-4 space-y-2">
                              {order.items.map((item, index) => (
                                <li key={index} className="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                  <span className="text-gray-800 font-medium">{item.name} x {item.quantity}</span>
                                  <div className="flex space-x-2">
                                    <button
                                      onClick={() => toggleItemStatus(order.id, index, 'isReady')}
                                      className={`px-3 py-1 rounded-full text-sm font-semibold transition duration-200 active:scale-95 transform
                                        ${item.isReady ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                      {item.isReady ? 'Ready!' : 'Ready?'}
                                    </button>
                                    <button
                                      onClick={() => toggleItemStatus(order.id, index, 'isServed')}
                                      className={`px-3 py-1 rounded-full text-sm font-semibold transition duration-200 active:scale-95 transform
                                        ${item.isServed ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                    >
                                      {item.isServed ? 'Served!' : 'Served?'}
                                    </button>
                                  </div>
                                </li>
                              ))}
                            </ul>
                            <div className="flex justify-end space-x-2 mt-4">
                              <button
                                onClick={() => toggleAllItemsStatus(order.id, 'isReady')}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200 shadow-md active:scale-98 transform"
                              >
                                All Ready
                              </button>
                              <button
                                onClick={() => toggleAllItemsStatus(order.id, 'isServed')}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 shadow-md active:scale-98 transform"
                              >
                                Serve All
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </section>
                )}

                {/* Completed Orders Section */}
                {activeSection === 'completedOrders' && (
                  <section className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">Completed Orders</h2>
                    {completedOrders.length === 0 ? (
                      <p className="text-gray-500 text-center">No completed orders yet.</p>
                    ) : (
                      <div className="space-y-6">
                        {completedOrders.map(order => (
                          <div key={order.id} className="bg-gray-100 p-5 rounded-xl shadow-md border border-gray-200">
                            <div className="flex justify-between items-center mb-3">
                              <h3 className="text-xl font-bold text-gray-800">Order #{order.orderNumber}</h3>
                              <span className="text-lg font-semibold text-gray-700">£{order.total.toFixed(2)}</span>
                            </div>
                            <p className="text-sm text-gray-600 mb-4">Paid at: {order.displayTime}</p>
                            <ul className="mb-4 space-y-2">
                              {order.items.map((item, index) => (
                                <li key={index} className="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm text-gray-700">
                                  <span>{item.name} x {item.quantity}</span>
                                  <div className="flex space-x-2 text-sm">
                                    <span className={item.isReady ? 'text-green-600 font-semibold' : 'text-gray-500'}>
                                      {item.isReady ? 'Ready' : 'Not Ready'}
                                    </span>
                                    <span className={item.isServed ? 'text-red-600 font-semibold' : 'text-gray-500'}>
                                      {item.isServed ? 'Served' : 'Not Served'}
                                    </span>
                                  </div>
                                </li>
                              ))}
                            </ul>
                            <div className="flex flex-wrap justify-end gap-2 mt-4">
                              <button
                                onClick={() => handleReopenOrder(order.id, order.orderNumber)}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 shadow-md text-sm active:scale-98 transform"
                              >
                                Reopen
                              </button>
                              <button
                                onClick={() => handleEditOrder(order)}
                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 shadow-md text-sm active:scale-98 transform"
                              >
                                Edit
                              </button>
                              <button
                                onClick={() => handleDeleteOrder(order.id, order.orderNumber)}
                                className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200 shadow-md text-sm active:scale-98 transform"
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </section>
                )}

                {/* Setup Section */}
                {activeSection === 'setup' && (
                  <section className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">App Setup</h2>

                    {/* Add/Remove Menu Items */}
                    <div className="mb-8 p-4 bg-red-50 rounded-lg shadow-sm">
                      <h3 className="text-xl font-bold text-gray-800 mb-3">Manage Menu Items</h3>
                      <div className="flex flex-col sm:flex-row gap-3 mb-4">
                        <input
                          type="text"
                          placeholder="Item Name"
                          value={newMenuItemName}
                          onChange={(e) => setNewMenuItemName(e.target.value)}
                          className="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                        />
                        <input
                          type="number"
                          placeholder="Price"
                          value={newMenuItemPrice}
                          onChange={(e) => setNewMenuItemPrice(e.target.value)}
                          className="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                        />
                        <button
                          onClick={handleAddMenuItem}
                          className="w-full sm:w-auto px-4 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200 active:scale-98 transform"
                        >
                          Add Item
                        </button>
                      </div>
                      <ul className="space-y-2">
                        {menuItems.length === 0 ? (
                          <p className="text-gray-500 text-center">No menu items defined.</p>
                        ) : (
                          menuItems.map(item => (
                            <li key={item.id} className="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                              <span className="font-medium">{item.name} - £{item.price.toFixed(2)}</span>
                              <button
                                onClick={() => handleDeleteMenuItem(item.id, item.name)}
                                className="bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm hover:bg-red-200 transition duration-200 active:scale-95 transform"
                              >
                                Delete
                              </button>
                            </li>
                          ))
                        )}
                      </ul>
                    </div>

                    {/* Export Orders */}
                    <div className="mb-8 p-4 bg-red-50 rounded-lg shadow-sm">
                      <h3 className="text-xl font-bold text-gray-800 mb-3">Data Management</h3>
                      <button
                        onClick={handleExportOrders}
                        className="w-full px-4 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-200 active:scale-98 transform"
                      >
                        Export All Orders to CSV
                      </button>
                    </div>

                    {/* Reset Order Count */}
                    <div className="p-4 bg-red-50 rounded-lg shadow-sm">
                      <h3 className="text-xl font-bold text-gray-800 mb-3">Order Counter</h3>
                      <button
                        onClick={handleResetOrderCount}
                        className="w-full px-4 py-3 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition duration-200 active:scale-98 transform"
                      >
                        Reset Order Count to 1
                      </button>
                    </div>
                  </section>
                )}
              </main>

              {/* Footer (optional, but good for mobile) */}
              <footer className="bg-red-600 text-white p-3 text-center text-sm sticky bottom-0 z-10">
                <p>&copy; 2025 BBQ Orders App. User ID: {userId || 'Loading...'}</p>
              </footer>

              {/* Tailwind CSS Script (for live preview in Canvas) */}
              <script src="https://cdn.tailwindcss.com"></script>
              <script
                dangerouslySetInnerHTML={{
                  __html: `
                    tailwind.config = {
                      theme: {
                        extend: {
                          fontFamily: {
                            inter: ['Inter', 'sans-serif'],
                          },
                          keyframes: {
                            pingOnce: {
                              '0%, 100%': { opacity: '0' },
                              '50%': { opacity: '1' },
                            }
                          },
                          animation: {
                            'ping-once': 'pingOnce 1s cubic-bezier(0, 0, 0.2, 1) forwards',
                          }
                        },
                      },
                    };
                  `,
                }}
              />
            </div>
          );
        }

        // Render the App component using ReactDOM
        // This will be called after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(React.createElement(App));
            } else {
                console.error("Root element with ID 'root' not found.");
            }
        });
    </script>
</body>
</html>
